<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Diamond DApp</title>
  <style>
    /* CSS Styles */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #1a202c;
      color: #edf2f7;
    }
    header, nav, main {
      padding: 1rem;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2d3748;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    nav a {
      margin-right: 1rem;
      color: #63b3ed;
      text-decoration: none;
    }
    nav a:hover {
      text-decoration: underline;
    }
    .button {
      background-color: #805ad5;
      color: #fff;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
    }
    .button:hover {
      background-color: #6b46c1;
    }
    .select, .input, .textarea {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
      background-color: #2d3748;
      color: #edf2f7;
      border: 1px solid #4a5568;
      border-radius: 0.25rem;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-container {
      background-color: #2d3748;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }
    .form-container h3 {
      margin-top: 0;
    }
    .alert {
      padding: 0.75rem;
      margin-bottom: 1rem;
      border-radius: 0.25rem;
    }
    .alert-success {
      background-color: #38a169;
      color: #fff;
    }
    .alert-error {
      background-color: #e53e3e;
      color: #fff;
    }
  </style>
</head>
<body>

<header>
  <div>
    <h1>Diamond DApp</h1>
    <p>Contract: <span id="contract-address">0x86935f11c86B623deCa825696E1C19a8659CbF95d</span></p>
    <p>Network: <span id="network-name">Polygon</span></p>
  </div>
  <button id="connect-wallet" class="button">Connect Wallet</button>
</header>

<nav>
  <a href="#">Home</a>
  <a href="https://eips.ethereum.org/EIPS/eip-2535" target="_blank">Diamond Standard (EIP-2535)</a>
  <a href="#" target="_blank">GitHub</a>
  <a href="#" target="_blank">Discord</a>
</nav>

<main>
  <div id="wallet-info"></div>

  <div class="form-group">
    <label for="facet-select">Select Facet:</label>
    <select id="facet-select" class="select">
      <option value="EscrowFacet">EscrowFacet</option>
      <!-- Add more facets if needed -->
    </select>
  </div>

  <div id="method-forms">
    <!-- Method forms will be dynamically inserted here -->
  </div>
</main>

<script>
  // JavaScript Code
  let userAddress = '';
  let contractAddress = '0x86935f11c86B623deCa825696E1C19a8659CbF95d'; // Polygon network
  let networkName = 'Polygon'; // Default network name
  let selectedFacet = 'EscrowFacet';
  let provider;
  let signer;

  const escrowFacetABI = {
    "depositERC20": {
      "constant": false,
      "inputs": [
        { "name": "tokenId", "type": "uint256" },
        { "name": "erc20Contract", "type": "address" },
        { "name": "value", "type": "uint256" }
      ],
      "name": "depositERC20",
      "outputs": [],
      "type": "function"
    },
    "batchDepositERC20": {
      "constant": false,
      "inputs": [
        { "name": "_tokenIds", "type": "uint256[]" },
        { "name": "erc20Contracts", "type": "address[]" },
        { "name": "_values", "type": "uint256[]" }
      ],
      "name": "batchDepositERC20",
      "outputs": [],
      "type": "function"
    },
    "transferEscrow": {
      "constant": false,
      "inputs": [
        { "name": "tokenId", "type": "uint256" },
        { "name": "erc20Contract", "type": "address" },
        { "name": "recipient", "type": "address" },
        { "name": "transferAmount", "type": "uint256" }
      ],
      "name": "transferEscrow",
      "outputs": [],
      "type": "function"
    },
    "batchTransferEscrow": {
      "constant": false,
      "inputs": [
        { "name": "_tokenIds", "type": "uint256[]" },
        { "name": "erc20Contracts", "type": "address[]" },
        { "name": "recipients", "type": "address[]" },
        { "name": "_transferAmounts", "type": "uint256[]" }
      ],
      "name": "batchTransferEscrow",
      "outputs": [],
      "type": "function"
    },
    "batchDepositGHST": {
      "constant": false,
      "inputs": [
        { "name": "_tokenIds", "type": "uint256[]" },
        { "name": "_values", "type": "uint256[]" }
      ],
      "name": "batchDepositGHST",
      "outputs": [],
      "type": "function"
    }
  };

  const methods = {
    'EscrowFacet': escrowFacetABI
    // Add more facets if needed
  };

  document.getElementById('connect-wallet').addEventListener('click', connectWallet);
  document.getElementById('facet-select').addEventListener('change', (e) => {
    selectedFacet = e.target.value;
    generateMethodForms();
  });

  async function connectWallet() {
    if (window.ethereum) {
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];
        provider = window.ethereum;
        // Get network name
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        networkName = getNetworkName(chainId);
        document.getElementById('network-name').innerText = networkName;
        document.getElementById('connect-wallet').innerText = `Connected: ${userAddress.slice(0, 6)}...`;
        document.getElementById('wallet-info').innerHTML = `<p>Wallet Address: ${userAddress}</p>`;
        generateMethodForms();
      } catch (error) {
        console.error(error);
        alert('Could not connect to wallet.');
      }
    } else {
      alert('Please install MetaMask!');
    }
  }

  function getNetworkName(chainId) {
    switch (chainId) {
      case '0x89':
        return 'Polygon';
      case '0x1':
        return 'Ethereum Mainnet';
      case '0x3':
        return 'Ropsten';
      // Add more networks as needed
      default:
        return 'Unknown';
    }
  }

  function generateMethodForms() {
    const methodArea = document.getElementById('method-forms');
    methodArea.innerHTML = '';

    if (!userAddress) {
      methodArea.innerHTML = '<p>Please connect your wallet to interact with the contract.</p>';
      return;
    }

    const facetMethods = methods[selectedFacet];
    for (let methodName in facetMethods) {
      const method = facetMethods[methodName];
      const formContainer = document.createElement('div');
      formContainer.className = 'form-container';
      const formTitle = document.createElement('h3');
      formTitle.innerText = methodName;
      formContainer.appendChild(formTitle);

      const form = document.createElement('form');
      form.setAttribute('data-method', methodName);
      form.addEventListener('submit', handleSubmit);

      method.inputs.forEach(input => {
        const inputGroup = document.createElement('div');
        inputGroup.className = 'form-group';
        const label = document.createElement('label');
        label.innerText = `${input.name} (${input.type}):`;
        const inputField = document.createElement('input');
        inputField.className = 'input';
        inputField.setAttribute('name', input.name);
        inputField.setAttribute('placeholder', input.type.includes('[]') ? 'Comma-separated values' : '');
        inputGroup.appendChild(label);
        inputGroup.appendChild(inputField);
        form.appendChild(inputGroup);
      });

      const submitButton = document.createElement('button');
      submitButton.className = 'button';
      submitButton.type = 'submit';
      submitButton.innerText = 'Submit';
      form.appendChild(submitButton);

      formContainer.appendChild(form);
      methodArea.appendChild(formContainer);
    }
  }

  async function handleSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const methodName = form.getAttribute('data-method');
    const method = methods[selectedFacet][methodName];
    const formData = new FormData(form);
    const args = [];

    try {
      for (let input of method.inputs) {
        let value = formData.get(input.name).trim();
        if (input.type.includes('[]')) {
          value = value.split(',').map(v => v.trim());
        }
        if (input.type.includes('uint256')) {
          if (Array.isArray(value)) {
            value = value.map(v => toHex(v));
          } else {
            value = toHex(value);
          }
        }
        args.push(value);
      }

      const txHash = await sendTransaction(methodName, method, args);
      alert(`${methodName} transaction sent. Tx Hash: ${txHash}`);
    } catch (error) {
      console.error(error);
      alert(`Error executing ${methodName}: ${error.message}`);
    }
  }

  function toHex(value) {
    return '0x' + BigInt(value).toString(16);
  }

  async function sendTransaction(methodName, method, args) {
    const data = encodeFunctionCall(method, args);
    const txParams = {
      from: userAddress,
      to: contractAddress,
      data: data
    };
    const txHash = await provider.request({
      method: 'eth_sendTransaction',
      params: [txParams],
    });
    return txHash;
  }

  function encodeFunctionCall(method, params) {
    const methodId = keccak256(method.name + '(' + method.inputs.map(i => i.type).join(',') + ')').substring(0, 10);
    const types = method.inputs.map(input => input.type);
    const values = params;
    const encodedParameters = encodeParameters(types, values);
    return methodId + encodedParameters;
  }

  function keccak256(input) {
    // Simplified keccak256 function for method ID generation
    // Note: In a production environment, use a proper keccak256 implementation
    return web3Utils.keccak256(input);
  }

  function encodeParameters(types, values) {
    // Simplified ABI encoding
    // Note: In a production environment, use a proper ABI encoder
    let encoded = '';
    for (let i = 0; i < types.length; i++) {
      let value = values[i];
      if (types[i].endsWith('[]')) {
        const arrayValues = value.map(v => v.replace(/^0x/, '').padStart(64, '0')).join('');
        const length = value.length.toString(16).padStart(64, '0');
        encoded += length + arrayValues;
      } else {
        encoded += value.replace(/^0x/, '').padStart(64, '0');
      }
    }
    return encoded;
  }

  // Placeholder for web3Utils.keccak256 function
  const web3Utils = {
    keccak256: function (value) {
      // Implement a keccak256 hash function or include an external library if allowed
      // For this example, we cannot compute the hash, so we'll return a dummy value
      // This will not work in a real application
      return '0x' + '0'.repeat(64);
    }
  };

  // Initial call to generate method forms if the wallet is already connected
  if (userAddress) {
    generateMethodForms();
  }
</script>

</body>
</html>
